{% extends "base.html" %}
{% block extraCss %}
{% endblock %}
{% block main %}
{% load static %}


<div id="main-content" class="profilepage_2 blog-page">
  <div class="container-fluid">
    <div class="block-header">
      <div class="row g-3">
        <div class="col-lg-5 col-md-8 col-sm-12">
          <h2><a href="javascript:void(0);" class="btn btn-xs btn-link btn-toggle-fullwidth"><i class="fa fa-arrow-left"></i></a>
            {{ titulo }}</h2>
            <ul class="breadcrumb">
              <li class="breadcrumb-item"><a href="{{ index }}"><i class="icon-home"></i></a></li>
              <li class="breadcrumb-item active">{{ titulo }}</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="row clearfix">
        <div class="col-lg-12 col-md-12">

          <div class="card">
            <div class="card-body">
              {% load static %}



              <div class="row div-form" style="display: none">
                <div class="col-sm-12 col-md-12 col-lg-12">
                  <p class="lead font-weight-bold mb-3">Nuevo Contrato</p>
                </div>
              </div>

              <form id="formContratos"  data-parsley-validate class="form-auth-small div-form" style="display: none">
                <div class="row" >

                  {% csrf_token %}

                  {% for m in form %}
                    {% if m.name == "proveedor_rs" or m.name == "proveedor_cuit" %}

                     <div class="form-group col-lg-4 form-group mb-2 form-sinProve" hidden>
                        <label>{{ m.label }}</label>
                        {{ m }}
                     </div>

                    {% else %}

                     <div class="form-group col-lg-4 form-group mb-2">
                        <label>{{ m.label }}</label>
                        {{ m }}
                     </div>

                    {% endif %}
                  {% endfor %}
                </div>
                <div class="row">
                  <div class="col-sm-12 col-md-2 offset-md-4 col-lg-2 offset-lg-4">
                    <button type="submit" class="btn btn-primary w-100">Guardar</button>
                  </div>
                  <div class="col-sm-12 col-md-2 col-md-offset-2 col-lg-2 col-lg-offset-4">
                    <button type="button" id="btnCancelar" class="btn btn-primary w-100">Cancelar</button>
                  </div>
                </div>
              </form>
              {% if admin == True %}
              <div class="row div-table-estadistica" style="display: none">
                <div class="col-sm-12 col-md-6 col-lg-2 offset-lg-4 mt-3">
                  <button class="btn btn-light w-100" id="btnTabla"><i class="fa fa-table"></i> Tabla</button>
                </div>
                <div class="col-sm-12 col-md-6 col-lg-2 mt-3">
                  <button class="btn btn-light w-100" id="btnEstadistica"><i class="fa icon-pie-chart"></i> Estadísticas</button>
                </div>
              </div>
             {% endif %}

            <div class="row div-table" style="display: none" >

                <div class="col-lg-3 offset-lg-4 col-md-3 offset-md-4 mt-3">
                    <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="inputGroup-sizing-sm">N° de Contrato</span>
                    </div>
                      <input type="number" class="form-control"  id="txt-nroSearch" autocomplete="off">
                  </div>
                </div>
                <div class="col-lg-1 col-md-1 mt-3">
                  <button onclick="cargarTabla()" class="btn btn-primary text-center w-100"><i class="fa fa-search"></i></button>
                </div>
              </div>

              <div class="row mt-3 div-table" style="display: none">
                <div class="table-responsive col-lg-12">
                  <table id="data_table_ajax" class="table table-bordered table-striped table-hover small">
                    <thead>
                      <tr>
                        <th width="5%">N°</th>
                        <th width="15%">Proveedor</th>
                        <th width="10%">CUIT</th>
                        <th width="10%">Medio</th>
                        <th width="10%">Programa</th>
                          <th width="10%">Repartición</th>
                        <th width="10%">Monto</th>
                        <th width="10%">Inicio</th>
                        <th width="10%">Fin</th>
                        <th width="10%">Estado</th>
                        {% if admin == True %}
                        <th align="center"></th>
                        {% endif %}
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>



              <div class="row div-estadistica-search" style="display: none" >
                <div class="col-lg-3 offset-lg-4 col-md-3 offset-md-4 mt-3">
                  <input id="txt-anioSearch" type="number" class="form-control w-100" value="{% now "Y" %}">
                </div>
                <div class="col-lg-1 col-md-1 mt-3">
                  <button onclick="cargarGraficos()" class="btn btn-primary text-center w-100"><i class="fa fa-search"></i></button>
                </div>
              </div>

            <div class="row div-estadistica-load" style="display: none" >
                <div class="col-lg-4 offset-lg-4 col-md-4 offset-md-4 mt-3">
                  <h6 class="text-black text-center"><i class="font-40 fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i><br>Cargando gráficos</h6>
                </div>
              </div>

              <div class="row clearfix div-estadistica" style="display: none" >
                <div class="col-lg-3 col-md-6 mt-3">
                  <div class="card overflowhidden">
                    <div class="body text-center">
                      <div class="p-15">
                        <h3 id="lblContratosCP"></h3>
                        <h7><i class="fa fa-user-o"></i> Proveedores Contratados</h7>
                      </div>
                    </div>
                    <div class="progress progress-xs progress-transparent custom-color-blue mb-0">
                      <div class="progress-bar"></div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mt-3">
                  <div class="card overflowhidden">
                    <div class="body text-center">
                      <div class="p-15">
                        <h3 id="lblContratosCR"></h3>
                        <h7><i class="fa fa-file-text-o"></i> Reparticiones Contratantes</h7>
                      </div>
                    </div>
                    <div class="progress progress-xs progress-transparent custom-color-yellow mb-0">
                      <div class="progress-bar"></div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mt-3">
                  <div class="card overflowhidden">
                    <div class="body text-center">
                      <div class="p-15">
                        <h3 id="lblContratosCM"></h3>
                        <h7><i class="fa fa-bullhorn"></i> Medios Utilizados</h7>
                      </div>
                    </div>
                    <div class="progress progress-xs progress-transparent custom-color-green mb-0">
                      <div class="progress-bar"></div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-3 col-md-6 mt-3">
                  <div class="card overflowhidden">
                    <div class="body text-center">
                      <div class="p-15">
                        <h3 id="lblContratosTM"></h3>
                        <h7><i class="fa fa-usd"></i> Monto Acumulado</h7>
                      </div>
                    </div>
                    <div class="progress progress-xs progress-transparent custom-color-purple mb-0">
                      <div class="progress-bar" data-transitiongoal="34"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mt-3 div-estadistica"  style="display: none">

                <div class="col-lg-12 col-md-12 col-sm-12">
                  <h5 class="text-center text-black">Ranking por cantidad de contratos</h5>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-CP"></div>
                  </div>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-CR"></div>
                  </div>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-CM"></div>
                  </div>
                </div>

                <div class="col-lg-12 col-md-12 col-sm-12 mt-3">
                  <h5 class="text-center text-black">Ranking por montos pagados</h5>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-MP"></div>
                  </div>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-MR"></div>
                  </div>
                </div>

                <div class="col-lg-4 col-md-12 col-sm-12">
                  <div class="card">
                    <div class="body body-MM"></div>
                  </div>
                </div>

              </div>

            </div>

          </div>
        </div>
      </div>
    </div>

  </div>


  <!-- --------------------------------------------------------------------------------- -->
  <!-- --------------------------------------------------------------------------------- -->
  <!-- --------------------------------------------------------------------------------- -->

  <div class="aux"></div>

  {% endblock %}
  {% block extraJS %}
  <script>
  /******************************************************************************************/
  /*************************** FUNCION PARA LA CARGA DE PAGINA ******************************/
  /******************************************************************************************/

  $(document).ready(function(){

    $('#formContratos').parsley();

    $(".div-table-estadistica, .div-table").show();

    cargarTabla();


  });

  /******************************************************************************************/
  /******************************************************************************************/
  /******************************************************************************************/

  /******************************************************************************************/
  /*********************** FUNCION PARA CARGAR DATOS EN DATATABLE  **************************/
  /******************************************************************************************/

  var table;

  function cargarTabla(){


    $('#data_table_ajax').dataTable().fnClearTable();
    $('#data_table_ajax').dataTable().fnDestroy();

    var valores = {
      "csrfmiddlewaretoken" : '{{ csrf_token }}',
      "nro" : $("#txt-nroSearch").val()
    }

    table = $('#data_table_ajax').DataTable({
      dom: 'Bfrtip',
      "deferRender": true,
      "pageLength": 10,
      "autoWidth": false,
      "processing": false,
      "searching" : false,

      buttons: [


        {
          text: '<i class="fa fa-plus"></i> <span> Nuevo Contrato</span>',
          className: 'btn-contrato btn btn-light mb-2 {% if admin != True %} hidden {% endif %}',
          visibility: false,
          action: function ( e, dt, node, config ) {
            nuevoContrato();
          }
        },


      ],
      language: {
        url: "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json"
      },
      "ajax": {
        "url": "{% url 'contratos_ajax' %}",
        "data": valores,
        "async": true,
        "type": "POST",
        "dataSrc": ""
      },
      'createdRow': function(row, data, rowIndex) {
        // Per-cell function to do whatever needed with cells
        $.each($('td', row), function(colIndex) {
          // For example, adding data-* attributes to the cell
          $(this).attr('title', $(this).text());
        });
      },
      "columns": [
        { "data": "id", "width": "5%" },
        {
          "data": null,
          "sortable": false,
          "width": "10%",
          "render": function(data, type, row) {

            if(data.user__profile__nombre){

                return data.user__profile__nombre;

            }else{

                return data.proveedor_rs;

            }
          }
        },
        {
          "data": null,
          "sortable": false,
          "width": "10%",
          "render": function(data, type, row) {

            if(data.user__username){

                return data.user__username;

            }else{

                return data.proveedor_cuit;

            }
          }
        },
        { "data": "medio__nombre", "width": "10%" },
        { "data": "programa", "width": "10%" },
        { "data": "reparticion__nombre", "width": "15%" },
        { "data": "monto_formateado", className: 'text-right', "width": "10%" },
        { "data": "fechaInicio_formateada" , "width": "10%"},
        { "data": "fechaFin_formateada" , "width": "10%"},
        {
          "data": null,
          "sortable": false,
          "render": function(data, type, row) {

            switch (data.status){
              case 'P':
              return '<span class="text-warning fw-bold">PENDIENTE</span>';
              break;
              case 'A':
              return '<span class="text-success fw-bold">AUTORIZADO</span>';
              break;
              case 'D':
              return '<span class="text-danger fw-bold">DENEGADO</span>';
              break;

            }
          }
        },

        {% if admin == True %}
        {
          "data": null,
          "sortable": false,
          "width" : "2%",
          "className": "",
          "render": function(data, type, row) {

            if (data.status == 'P'){

              return '<button type="button" onclick="imprimirContrato('+data.id+')" class="btn btn-outline-secondary js-detalle" title="Reimprimir Contrato"><i class="fa fa-print"></i></button> ' +
              '<button type="button" onclick="autorizarContrato('+data.id+')" class="btn btn-outline-secondary js-detalle" title="Autorizar Contrato"><i class="fa fa-check"></i></button> ' +
              '<button type="button" onclick="denegarContrato('+data.id+')" class="btn btn-outline-secondary js-detalle" title="Denegar Contrato"><i class="fa fa-close"></i></button> '



            } else{
              return '<button type="button" onclick="imprimirContrato('+data.id+')" class="btn btn-outline-secondary js-detalle" title="Reimprimir Contrato"><i class="fa fa-print"></i></button>'
            }


          }
        },
        {% endif %}

      ],
      initComplete: function (settings, json) {
        $(".btn-contrato").removeClass("dt-button");
      },
      {#order: [[0, 'desc']]#}
    });



  }


  /******************************************************************************************/
  /******************************************************************************************/
  /******************************************************************************************/


  {% if admin == True %}

  function nuevoContrato(){

    $("#formContratos").trigger("reset").parsley().reset();
    $("#id_conProveedor").change();
    $(".div-table, .div-table-estadistica").hide(200);
    $(".div-form").show(200);

  }

  $("#btnCancelar").click(function(){

    $("#formContratos").trigger("reset").parsley().reset();
    $(".div-form").hide(200);
    $(".div-table, .div-table-estadistica").show(200);

  });


  $('#formContratos').on('submit', function(event) {

   event.preventDefault();

    var form = $(this);
    form.parsley().validate();

    if (form.parsley().isValid()) {

        $.ajax({
      type: 'POST',
      async: false,
      url: "{% url 'submitContrato' %}",
      data: $(this).serialize(),
      success: function(data) {

        swal("Operación Exitosa!", "Se cargo exitosamente el contrato N° "+data.contrato, "success");
        $(".div-form").hide(200);
        table.ajax.reload(null, false);
        $(".div-table, .div-table-estadistica").show(200);

       }
      });

    }

  });


  function imprimirContrato(id){
    $(".aux").html('<form id="verPdf" action="{% url 'contrato_pdf' %}" target="_blank" method="POST">{%  csrf_token %}' +
    '<input name="id" value="'+id+'"/>' +
    '</form>');

    $("#verPdf").submit();

    $(".aux").html('');
  }

  function autorizarContrato(id){

    swal({
      title: "Atención!",
      text: "Está por autorizar el contrato numero "+id+", esta operación no se puede deshacer. ¿Autorizar de todos modos?",
      icon: "warning",
      buttons: {
        cancelar : {
          text: "Cancelar",
          className: "swal-button--cancel"
        },
        autorizar:  {
          text: "Autorizar",
          className: "swal-button--confirm"
        },


      },
    }).then((value) => {
      switch (value) {

        case "autorizar":

        var valores = {
          "csrfmiddlewaretoken" : '{{csrf_token }}',
          "id": id,
        }

        $.ajax({
          url: '{% url 'autorizar_contrato' %}',
          type: 'POST',
          data: valores,
          success: function(data) {

            swal('Operación Exitosa!', 'El contrato fue Autorizado correatamente.' , 'success');
            table.ajax.reload(null, false);
          },
        });

        break;

        case "cancelar":
        swal.close()
        break;

      }
    });
  }



  function denegarContrato(id){

    swal({
      title: "Atención!",
      text: "Está por denegar el contrato numero "+id+", esta operación no se puede deshacer. ¿Denegar de todos modos?",
      icon: "warning",
      buttons: {
        cancelar : {
          text: "Cancelar",
          className: "swal-button--cancel"
        },
        denegar:  {
          text: "Denegar",
          className: "swal-button--confirm"
        },


      },
    }).then((value) => {
      switch (value) {

        case "denegar":

        var valores = {
          "csrfmiddlewaretoken" : '{{csrf_token }}',
          "id": id,
        }

        $.ajax({
          url: '{% url 'denegar_contrato' %}',
          type: 'POST',
          data: valores,
          success: function(data) {

            swal('Operación Exitosa!', 'El contrato fue Denegado correatamente.' , 'success');
            table.ajax.reload(null, false);
          },
        });

        break;

        case "cancelar":
        swal.close()
        break;

      }
    });
  }



  function cargarGraficos() {

    $(".div-estadistica").hide();
    $(".div-estadistica-search").show(200);
    var valores = {
      "csrfmiddlewaretoken" : '{{ csrf_token }}',
      "anio" : $("#txt-anioSearch").val()
    }

    array_top10_CP = [];
    array_top10_MP = [];

    array_top10_CR = [];
    array_top10_MR = [];

    array_top10_CM = [];
    array_top10_MM = [];

    $.ajax({
      url: '{% url 'datos_graficos' %}',
      type: 'POST',
      data: valores,
      async: true,
      beforeSend: function ( xhr ) {
          $(".div-estadistica-load").show(200);
      },
      dataType: 'json',
      success: function(data) {
        $(".div-estadistica-load").hide(200);
        $(".div-estadistica").show(200);

        $("#lblContratosCP").text(data.cantidad_proveedores);
        $("#lblContratosCR").text(data.cantidad_reparticion);
        $("#lblContratosCM").text(data.cantidad_medio);
        $("#lblContratosTM").text("$ "+data.monto_acumulado);

        array_top10_CP = data.top_10_arrayCP;
        array_top10_MP = data.top_10_arrayMP;

        array_top10_CR = data.top_10_arrayCR;
        array_top10_MR = data.top_10_arrayMR;

        array_top10_CM = data.top_10_arrayCM;
        array_top10_MM = data.top_10_arrayMM;



        $(".body-CP").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de proveedores</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-proveedor" style="height:400px" class="graph m-t-20 text-center">' +
        '</div>');

        $(".body-MP").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de proveedores</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-MProveedores" style="height:400px" class="graph m-t-20 text-center">' +
        '</div>');

        $(".body-CR").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de reparticiones</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-reparticion" style="height:400px" class="graph m-t-20 text-center"></div>' +
        '</div>');

        $(".body-MR").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de reparticiones</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-MReparticion" style="height:400px" class="graph m-t-20 text-center"></div>' +
        '</div>');

        $(".body-CM").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de medios</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-medios" style="height:400px" class="graph m-t-20 text-center"></div>' +
        '</div>');

        $(".body-MM").html('<div class="row text-center">' +
        '<div class="col-sm-12 col-12"> ' +
        '<h5 class="m-0">Ranking de medios</h5>' +
        ' </div> ' +
        '</div>' +
        '<div id="bar-MMedios" style="height:400px" class="graph m-t-20 text-center"></div>' +
        '</div>');


        if(array_top10_CP.length > 0 ) {
          Morris.Bar({
            element: 'bar-proveedor',
            data: array_top10_CP,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Contratos'],
            barColors: ['#6ebdd1'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }else{
          $("#bar-proveedor").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

        if(array_top10_CR.length > 0 ) {
          Morris.Bar({
            element: 'bar-reparticion',
            data: array_top10_CR,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Contratos'],
            barColors: ['#afc979'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }else{
          $("#bar-reparticion").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

        if(array_top10_CM.length > 0 ) {
          Morris.Bar({
            element: 'bar-medios',
            data: array_top10_CM,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Contratos'],
            barColors: ['#faab6c'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }else{
          $("#bar-medios").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

        if(array_top10_MP.length > 0 ) {
          Morris.Bar({
            element: 'bar-MProveedores',
            data: array_top10_MP,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Monto $'],
            barColors: ['#81ccba'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }else{
          $("#bar-MProveedores").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

        if(array_top10_MR.length > 0 ) {
          Morris.Bar({
            element: 'bar-MReparticion',
            data: array_top10_MR,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Monto $'],
            barColors: ['#fcde85'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }
        else{
          $("#bar-MReparticion").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

        if(array_top10_MM.length > 0 ) {
          Morris.Bar({
            element: 'bar-MMedios',
            data: array_top10_MM,
            xkey: 'y',
            ykeys: 'a',
            resize: true,
            xLabelAngle: 90,
            labels: ['Monto $'],
            barColors: ['#f79dc9'],
            hideHover: 'auto',
            gridLineColor: '#eeeeee',
          });
        }else{
          $("#bar-MMedios").css('height', 'auto').html('<p class="text-center">No se encuentran datos!</p>');
        }

      }
    });
  }


  $("#btnTabla").click(function(){

    table.ajax.reload(null, false);
    $(".div-table").show(200);
    $(".div-estadistica, .div-estadistica-search").hide(200);

  });

  $("#btnEstadistica").click(function(){


    $(".div-table").hide(200);

    cargarGraficos();

  });


  $("#txt-anioSearch").change(function(){
    if (this.value == ''){
      $("#txt-anioSearch").val("{% now "Y" %}");
   }
  });

  function controlConProveedor(val){

      switch (val){
          case 'NO':
              $(".form-sinProve").removeAttr('hidden').show();
              $("#id_usuario").removeAttr('required').val('').attr('disabled', true);
              $("#id_proveedor_rs, #id_proveedor_cuit").attr('required', true);
          break;
          default:
          case 'SI':
              $(".form-sinProve").hide();
              $("#id_usuario").attr('required', true).removeAttr('disabled');
              $("#id_proveedor_rs, #id_proveedor_cuit").removeAttr('required');
          break;
      }

  }

 {% endif %}
</script>


{% endblock %}